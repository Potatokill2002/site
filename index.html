<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive KPI Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --accent-blue: #38bdf8;
            --accent-green: #22c55e;
            --accent-yellow: #f59e0b;
            --accent-red: #ef4444;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --card-border: #334155;
            --checkbox-bg: #334155;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }

        body {
            background-color: var(--bg-primary);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Navigation */
        nav {
            background: var(--bg-secondary);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--card-border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-links { display: flex; gap: 20px; }
        .nav-links button {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-weight: 600;
            padding: 8px 12px;
            border-radius: 6px;
            transition: 0.2s;
        }
        .nav-links button.active {
            color: var(--accent-blue);
            background: rgba(56, 189, 248, 0.1);
        }

        /* Container */
        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 20px;
            width: 100%;
            flex-grow: 1;
        }

        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Split Layout for Tracking */
        .tracking-layout {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 24px;
        }

        @media (max-width: 900px) {
            .tracking-layout { grid-template-columns: 1fr; }
        }

        /* Card Styles */
        .card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--card-border);
        }

        .card-header {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid var(--card-border);
            padding-bottom: 10px;
        }

        .card-title { font-size: 1.1rem; color: var(--accent-blue); }

        /* Checklist Styles */
        .task-row { margin-bottom: 25px; }
        .task-label { font-size: 0.95rem; margin-bottom: 12px; display: block; color: var(--text-main); }
        .checkbox-grid { display: flex; flex-wrap: wrap; gap: 8px; }

        .check-item { position: relative; width: 38px; height: 38px; }
        .check-item input { opacity: 0; width: 0; height: 0; position: absolute; }
        .check-mark {
            position: absolute; top: 0; left: 0; height: 38px; width: 38px;
            background-color: var(--checkbox-bg); border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s; border: 2px solid transparent;
        }
        .check-item input:checked + .check-mark { background-color: var(--accent-blue); border-color: var(--text-main); }
        .check-item input:checked + .check-mark::after { content: '✓'; color: var(--bg-primary); font-weight: bold; font-size: 1.1rem; }

        /* Calendar Styles */
        .calendar-card { position: sticky; top: 100px; height: fit-content; }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-top: 15px;
        }
        .cal-day-label { font-size: 0.7rem; color: var(--text-dim); text-align: center; text-transform: uppercase; }
        .cal-day {
            aspect-ratio: 1;
            background: var(--bg-primary);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            position: relative;
            border: 1px solid var(--card-border);
        }
        .cal-day.today { border-color: var(--accent-blue); }
        .status-dot {
            width: 6px; height: 6px; border-radius: 50%;
            position: absolute; bottom: 4px;
        }
        .dot-green { background: var(--accent-green); box-shadow: 0 0 5px var(--accent-green); }
        .dot-yellow { background: var(--accent-yellow); box-shadow: 0 0 5px var(--accent-yellow); }
        .dot-red { background: var(--accent-red); box-shadow: 0 0 5px var(--accent-red); }

        /* Analytics Controls */
        .date-picker-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .date-input {
            background: var(--bg-secondary);
            border: 1px solid var(--card-border);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            outline: none;
        }
        .date-input:focus { border-color: var(--accent-blue); }

        /* Save Button */
        .save-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--accent-blue); color: var(--bg-primary);
            padding: 12px 30px; border-radius: 50px; font-weight: bold;
            border: none; cursor: pointer; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 10px; z-index: 1000;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .chart-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--card-border);
            height: 350px;
        }
        @media (max-width: 768px) { .stats-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<nav>
    <div style="display: flex; align-items: center; gap: 10px;">
        <i data-lucide="check-square" style="color: var(--accent-blue)"></i>
        <h2 style="font-size: 1.1rem">Jairo's Manager</h2>
    </div>
    <div class="nav-links">
        <button id="btn-track" class="active" onclick="showPage('track')">Tracking</button>
        <button id="btn-stats" onclick="showPage('stats')">Analytics</button>
    </div>
    <div class="controls">
        <button onclick="exportJSON()" style="background: none; border: 1px solid var(--card-border); color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.7rem;">Export Data</button>
    </div>
</nav>

<div class="container">
    <!-- TRACKING PAGE -->
    <div id="page-track" class="page active">
        <div class="tracking-layout">
            <div class="main-checklist">
                <header style="margin-bottom: 20px">
                    <h1 id="currentDate">Daily Checklist</h1>
                    <p style="color: var(--text-dim)">Track your performance for today.</p>
                </header>

                <div class="card">
                    <div class="card-header"><i data-lucide="disc"></i><span class="card-title">STR Client (DVDs)</span></div>
                    <div class="task-row">
                        <label class="task-label">Jairo: Daily Fixes (Goal: 5)</label>
                        <div class="checkbox-grid" id="grid-jairo-dvds"></div>
                    </div>
                    <div class="task-row">
                        <label class="task-label">Cesar: Daily Fixes (Goal: 10)</label>
                        <div class="checkbox-grid" id="grid-cesar-dvds"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><i data-lucide="briefcase"></i><span class="card-title">Consulting</span></div>
                    <div class="task-row">
                        <label class="task-label">Stanley: Leads (Goal: 8)</label>
                        <div class="checkbox-grid" id="grid-stanley-leads"></div>
                    </div>
                    <div class="task-row">
                        <label class="task-label">Jairo: Quotes (Goal: 5)</label>
                        <div class="checkbox-grid" id="grid-jairo-quotes"></div>
                    </div>
                    <div class="task-row">
                        <label class="task-label">Jairo: Contracts (Goal: 1)</label>
                        <div class="checkbox-grid" id="grid-jairo-contracts"></div>
                    </div>
                </div>
            </div>

            <!-- Calendar Sidebar -->
            <aside>
                <div class="card calendar-card">
                    <div class="card-header" style="border:none; margin:0">
                        <i data-lucide="calendar" style="width:16px"></i>
                        <span style="font-size: 0.9rem; font-weight:bold" id="calMonth">Current Month</span>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Labels -->
                        <div class="cal-day-label">S</div><div class="cal-day-label">M</div><div class="cal-day-label">T</div>
                        <div class="cal-day-label">W</div><div class="cal-day-label">T</div><div class="cal-day-label">F</div>
                        <div class="cal-day-label">S</div>
                    </div>
                    <div style="margin-top: 20px; font-size: 0.7rem; color: var(--text-dim); display:flex; gap:10px; justify-content:center;">
                        <span><i style="color:var(--accent-green)">●</i> Met</span>
                        <span><i style="color:var(--accent-yellow)">●</i> Partial</span>
                        <span><i style="color:var(--accent-red)">●</i> Low</span>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- STATS PAGE -->
    <div id="page-stats" class="page">
        <header style="margin-bottom: 20px">
            <h1>Range Analysis</h1>
            <p style="color: var(--text-dim)">Select a date range to aggregate stats from your history.</p>
            <div class="date-picker-group">
                <div style="display:flex; flex-direction:column; gap:5px">
                    <label style="font-size:0.7rem; color:var(--text-dim)">From:</label>
                    <input type="date" id="startDate" class="date-input" onchange="renderCharts()">
                </div>
                <div style="display:flex; flex-direction:column; gap:5px">
                    <label style="font-size:0.7rem; color:var(--text-dim)">To:</label>
                    <input type="date" id="endDate" class="date-input" onchange="renderCharts()">
                </div>
                <button onclick="setRange('today')" style="background:transparent; border:1px solid var(--accent-blue); color:var(--accent-blue); padding:8px 12px; border-radius:8px; cursor:pointer; font-size:0.8rem; margin-top:18px">Today</button>
            </div>
        </header>
        
        <div class="stats-grid">
            <div class="chart-container"><canvas id="barChart"></canvas></div>
            <div class="chart-container"><canvas id="pieChart"></canvas></div>
        </div>
        
        <div id="rangeInfo" style="margin-top:20px; color:var(--text-dim); font-size:0.85rem; text-align:center"></div>
    </div>
</div>

<button class="save-bar" onclick="manualSave()">
    <i data-lucide="save"></i> Save Daily Progress
</button>

<script>
    const CONFIG = {
        jairo_dvds: 5,
        cesar_dvds: 10,
        stanley_leads: 8,
        jairo_quotes: 5,
        jairo_contracts: 1
    };

    // history stores: { "DateString": { counts: {jairo_dvds: 5, ...}, status: "green" } }
    let appState = {
        jairo_dvds: 0,
        cesar_dvds: 0,
        stanley_leads: 0,
        jairo_quotes: 0,
        jairo_contracts: 0,
        history: {}
    };

    let barChart, pieChart;

    window.onload = () => {
        lucide.createIcons();
        document.getElementById('currentDate').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
        
        // Default range to today
        const todayStr = new Date().toISOString().split('T')[0];
        document.getElementById('startDate').value = todayStr;
        document.getElementById('endDate').value = todayStr;

        loadFromStorage();
        checkAutoReset();
        generateCheckboxes();
        renderCalendar();
        initCharts();
    };

    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-links button').forEach(b => b.classList.remove('active'));
        document.getElementById(`page-${pageId}`).classList.add('active');
        document.getElementById(`btn-${pageId}`).classList.add('active');
        if (pageId === 'stats') renderCharts();
    }

    function generateCheckboxes() {
        createGrid('grid-jairo-dvds', 'jairo_dvds', 5);
        createGrid('grid-cesar-dvds', 'cesar_dvds', 10);
        createGrid('grid-stanley-leads', 'stanley_leads', 10);
        createGrid('grid-jairo-quotes', 'jairo_quotes', 5);
        createGrid('grid-jairo-contracts', 'jairo_contracts', 1);
    }

    function createGrid(containerId, stateKey, count) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        for (let i = 1; i <= count; i++) {
            const item = document.createElement('div');
            item.className = 'check-item';
            const checked = i <= appState[stateKey] ? 'checked' : '';
            item.innerHTML = `
                <input type="checkbox" id="${stateKey}_${i}" ${checked} onchange="updateCount('${stateKey}')">
                <label class="check-mark" for="${stateKey}_${i}"></label>
            `;
            container.appendChild(item);
        }
    }

    function updateCount(key) {
        appState[key] = document.querySelectorAll(`input[id^="${key}_"]:checked`).length;
    }

    function calculateDailyStatus() {
        let met = 0;
        let totalKeys = Object.keys(CONFIG).length;
        Object.keys(CONFIG).forEach(key => {
            if (appState[key] >= CONFIG[key]) met++;
        });
        if (met === totalKeys) return 'green';
        if (met > 0) return 'yellow';
        return 'red';
    }

    function manualSave() {
        const today = new Date().toDateString();
        appState.history[today] = {
            counts: {
                jairo_dvds: appState.jairo_dvds,
                cesar_dvds: appState.cesar_dvds,
                stanley_leads: appState.stanley_leads,
                jairo_quotes: appState.jairo_quotes,
                jairo_contracts: appState.jairo_contracts
            },
            status: calculateDailyStatus()
        };
        localStorage.setItem('kpi_dashboard_state_v3', JSON.stringify(appState));
        localStorage.setItem('last_active_date', today);
        
        renderCalendar();
        
        const btn = document.querySelector('.save-bar');
        btn.innerHTML = 'Day Recorded!';
        btn.style.background = '#22c55e';
        setTimeout(() => {
            btn.innerHTML = '<i data-lucide="save"></i> Save Daily Progress';
            btn.style.background = 'var(--accent-blue)';
            lucide.createIcons();
        }, 2000);
    }

    function loadFromStorage() {
        const saved = localStorage.getItem('kpi_dashboard_state_v3');
        if (saved) appState = JSON.parse(saved);
    }

    function checkAutoReset() {
        const lastDate = localStorage.getItem('last_active_date');
        const today = new Date().toDateString();
        if (lastDate && lastDate !== today) {
            appState.jairo_dvds = 0;
            appState.cesar_dvds = 0;
            appState.stanley_leads = 0;
            appState.jairo_quotes = 0;
            appState.jairo_contracts = 0;
        }
    }

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const monthLabel = document.getElementById('calMonth');
        const now = new Date();
        monthLabel.innerText = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        const labels = grid.querySelectorAll('.cal-day-label');
        grid.innerHTML = '';
        labels.forEach(l => grid.appendChild(l));
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).getDay();
        const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
        for (let i = 0; i < firstDay; i++) grid.appendChild(document.createElement('div'));
        for (let d = 1; d <= daysInMonth; d++) {
            const dayEl = document.createElement('div');
            dayEl.className = 'cal-day';
            const dateStr = new Date(now.getFullYear(), now.getMonth(), d).toDateString();
            if (dateStr === now.toDateString()) dayEl.classList.add('today');
            dayEl.innerText = d;
            const entry = appState.history[dateStr];
            if (entry) {
                const dot = document.createElement('div');
                dot.className = `status-dot dot-${entry.status}`;
                dayEl.appendChild(dot);
            }
            grid.appendChild(dayEl);
        }
    }

    function initCharts() {
        const ctxBar = document.getElementById('barChart').getContext('2d');
        const ctxPie = document.getElementById('pieChart').getContext('2d');
        barChart = new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: ['Jairo DVD', 'Cesar DVD', 'Leads', 'Quotes', 'Contracts'],
                datasets: [
                    { label: 'Aggregated Actual', data: [0,0,0,0,0], backgroundColor: '#38bdf8', borderRadius: 5 },
                    { label: 'Aggregated Target', data: [0,0,0,0,0], backgroundColor: 'rgba(255,255,255,0.1)', borderColor: '#94a3b8', borderWidth: 1, borderRadius: 5 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
        pieChart = new Chart(ctxPie, {
            type: 'doughnut',
            data: {
                labels: ['STR Client', 'Consulting'],
                datasets: [{ data: [1, 1], backgroundColor: ['#38bdf8', '#22c55e'], borderWidth: 0 }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function setRange(mode) {
        if (mode === 'today') {
            const todayStr = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = todayStr;
            document.getElementById('endDate').value = todayStr;
            renderCharts();
        }
    }

    function renderCharts() {
        const start = new Date(document.getElementById('startDate').value + "T00:00:00");
        const end = new Date(document.getElementById('endDate').value + "T23:59:59");
        
        let totals = { jairo_dvds: 0, cesar_dvds: 0, stanley_leads: 0, jairo_quotes: 0, jairo_contracts: 0 };
        let daysFound = 0;

        // Iterate through all saved history
        Object.keys(appState.history).forEach(dateStr => {
            const entryDate = new Date(dateStr);
            if (entryDate >= start && entryDate <= end) {
                const counts = appState.history[dateStr].counts || {};
                Object.keys(totals).forEach(key => {
                    totals[key] += (counts[key] || 0);
                });
                daysFound++;
            }
        });

        // If analyzing "Today" specifically, include current non-saved session if date matches
        const todayStr = new Date().toDateString();
        const todayDate = new Date();
        if (todayDate >= start && todayDate <= end && !appState.history[todayStr]) {
            totals.jairo_dvds += appState.jairo_dvds;
            totals.cesar_dvds += appState.cesar_dvds;
            totals.stanley_leads += appState.stanley_leads;
            totals.jairo_quotes += appState.jairo_quotes;
            totals.jairo_contracts += appState.jairo_contracts;
            daysFound++;
        }

        // Target is based on the number of days in range
        const diffTime = Math.abs(end - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        const multiplier = diffDays || 1;

        barChart.data.datasets[0].data = [totals.jairo_dvds, totals.cesar_dvds, totals.stanley_leads, totals.jairo_quotes, totals.jairo_contracts];
        barChart.data.datasets[1].data = [CONFIG.jairo_dvds*multiplier, CONFIG.cesar_dvds*multiplier, CONFIG.stanley_leads*multiplier, CONFIG.jairo_quotes*multiplier, CONFIG.jairo_contracts*multiplier];
        barChart.update();

        const str = totals.jairo_dvds + totals.cesar_dvds;
        const cons = totals.stanley_leads + totals.jairo_quotes + totals.jairo_contracts;
        pieChart.data.datasets[0].data = [str || 1, cons || 1];
        pieChart.update();

        document.getElementById('rangeInfo').innerText = `Analyzing ${multiplier} day(s). Found data for ${daysFound} day(s) in this period.`;
    }

    function exportJSON() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appState));
        const dl = document.createElement('a');
        dl.setAttribute("href", dataStr);
        dl.setAttribute("download", `kpi_full_history.json`);
        dl.click();
    }
</script>

</body>
</html>
